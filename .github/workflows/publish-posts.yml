name: Publish Tech Posts to Medium

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  publish-to-medium:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Publish to Medium
        env:
          MEDIUM_API_TOKEN: ${{ secrets.MEDIUM_API_TOKEN }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import glob
          import re
          import requests

          medium_token = os.environ.get('MEDIUM_API_TOKEN')

          if not medium_token:
              print("MEDIUM_API_TOKEN not set. Skipping publishing.")
              exit(0)

          # Find generated posts that haven't been published
          post_files = glob.glob('posts/post-*.md')
          to_publish = []

          for post_file in post_files:
              with open(post_file, 'r') as f:
                  content = f.read()
                  if 'status: generated' in content:
                      to_publish.append(post_file)

          if not to_publish:
              print("No posts to publish")
              exit(0)

          print(f"Found {len(to_publish)} post(s) to publish")

          # Get Medium user ID
          headers = {
              'Authorization': f'Bearer {medium_token}',
              'Content-Type': 'application/json',
              'Accept': 'application/json'
          }

          try:
              user_response = requests.get('https://api.medium.com/v1/me', headers=headers)
              user_response.raise_for_status()
              user_id = user_response.json()['data']['id']
              print(f"Medium user ID: {user_id}")
          except Exception as e:
              print(f"Error getting Medium user: {e}")
              exit(1)

          # Publish each post
          for post_file in to_publish:
              print(f"\nPublishing {post_file}...")
              
              with open(post_file, 'r') as f:
                  content = f.read()

              # Extract content after frontmatter
              parts = content.split('---\n', 2)
              if len(parts) >= 3:
                  post_content = parts[2].strip()
              else:
                  post_content = content

              # Extract title from content
              lines = post_content.split('\n')
              title = lines[0].replace('#', '').strip() if lines else 'Tech Post'

              # Prepare Medium post
              post_data = {
                  'title': title,
                  'contentFormat': 'markdown',
                  'content': post_content,
                  'publishStatus': 'public',
                  'tags': ['technology', 'programming', 'software-development']
              }

              try:
                  publish_response = requests.post(
                      f'https://api.medium.com/v1/users/{user_id}/posts',
                      headers=headers,
                      json=post_data
                  )
                  publish_response.raise_for_status()
                  
                  result = publish_response.json()
                  post_url = result['data']['url']
                  print(f"Published successfully: {post_url}")
                  
                  # Update post status - use regex to only replace in frontmatter
                  import re
                  updated_content = re.sub(
                      r'^status:\s*generated\s*$',
                      f'status: published\npublished_url: {post_url}',
                      content,
                      count=1,
                      flags=re.MULTILINE
                  )
                  with open(post_file, 'w') as f:
                      f.write(updated_content)
                  
              except Exception as e:
                  print(f"Error publishing {post_file}: {e}")
                  if hasattr(e, 'response'):
                      print(f"Response: {e.response.text}")
                  continue

          print("\nPublishing completed")
          PYTHON_SCRIPT

      - name: Commit and push updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add posts/
          git commit -m "Update published post statuses" || echo "No changes to commit"
          # Push to main branch explicitly
          git push origin main
